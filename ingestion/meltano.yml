default_environment: dev
project_id: 019bade9-449d-7a3e-a00f-88cfd8b15220

environments:
- name: dev
  config:
    plugins:
      extractors:
      - name: tap-postgres
        select:
        - '!*.*.*'
        - public-stg_governo_gastos.*
        loaders:
        - name: target-s3
          config:
            s3_key_prefix: "dev/bronze/stg_governo_gastos/"

- name: staging
- name: prod

plugins:
  extractors:
  - name: tap-postgres
    variant: meltanolabs
    pip_url: meltanolabs-tap-postgres
    config:
      host: ${PG_HOST}
      port: 5432
      user: ${PG_USER}
      password: ${PG_PASSWORD}
      database: ${PG_DATABASE}

  loaders:
  - name: target-s3
    variant: crowemi
    config:
      # 1. MUDANÇA PARA PARQUET
      format:
        format_type: parquet
      
      cloud_provider:
        cloud_provider_type: aws
        aws:
          aws_bucket: db-despesas
          aws_region: us-east-2
      
      # 2. CORREÇÃO DO CAMINHO (Removi a barra extra)
      prefix: "bronze/stg_governo_gastos" 
      append_date_to_prefix: true
      partition_name_enabled: true
      
      # 3. RESOLUÇÃO DA SOBRESCRITA (Nome do ficheiro com segundos)
      append_date_to_filename: true
      append_date_to_filename_grain: second # Adiciona HHMMSS ao nome, impedindo a sobrescrita
      
      # 4. AUMENTAR A BATCH (Cabe as 100k linhas num ficheiro só se preferir)
      max_batch_size: 35000
